% Hua-sheng XIE, huashengxie@gmail.com, ENN, 2025-02-07 10:04
% matrix method to solve EM3D model, fix omega & kz, to solve kx
% with L-pole for Bessel Gamma_n
% 13:20 test EBW, seems OK
% 14:00 test ICRF, Fast Wave branch not ok
% 22:28 fixed a minus sign bug on yy term
% 25-02-08 08:15 test ICRF, N=4, IBW&FW Re(kperp) both agree with fsolve now
% but FW Im(kperp) incorrect
% 23:45 fix a '-1i' bug on yz term, Im(kperp) also agree
% Ref: H. S. Xie, Linear Fluid Plasma Model with Accurate Kinetic Bernstein
%      Waves, 2025.
close all; clear; clc;

% 1. default SI unit
c2=(2.99792458E8)^2; % speed of ligth c^2
epsilon0=8.854187817E-12;
mu0=1/(c2*epsilon0);
kB=1.38064852e-23;
qe=1.60217662e-19; % electron charge, coulombs
mp=1.6726219e-27; % proton mass, kg
me=9.1094e-31; % electron mass, kg

% 2. set parameters, modify here for your own case
jcase=2;
if(jcase==1)
  ms=[me,2*mp]; % speceis mass
  qs=[-1,1]*qe; % speceis charge
  ns_unit=[1,1]; % *den0, species density, m^-3
  Ts_unit=[1,1]; % eV
  S=length(ms);

  B0=6e0; % background B field, Tesla
  n00=2e20; % m^-3
  % f=28e9; % Hz

  T00=2*2e3; % eV
  % w=f*2*pi; % omega

  kz=2*5.0;
elseif(jcase==2)
  ms=me; % speceis mass
  qs=-1*qe; % speceis charge
  ns_unit=1; % *den0, species density, m^-3
  Ts_unit=1; % eV
  S=length(ms);

  B0=1e0; % background B field, Tesla
  n00=6.075e19; % m^-3
  % f=28e9; % Hz

  T00=1e3; % eV
  kz=0.0;
end

ns0=ns_unit*n00;
Ts0=Ts_unit*T00*1.6022e-19/kB; % Ts, eV -> K
vts=sqrt(2*kB*Ts0./ms); % thermal velocity
c=sqrt(c2);

wcs=qs*B0./ms; % the gyro frequency
wps=sqrt(ns0.*qs.^2./ms/epsilon0); % plasma frequency
wcs2=wcs.^2;
wps2=wps.^2;
wp2=sum(wps2);
rhocs=sqrt(kB*Ts0./ms)./wcs; % cyclotron radius
absrhocs=abs(rhocs);
sgns=sign(rhocs);
% sgns=abs(sign(rhocs));

lambdaDs=sqrt(epsilon0*kB*Ts0./(ns0.*qs.^2)); % Debye length, Tzs
kDs=1./lambdaDs;
% kn=abs(kDs(1));

wcn=min(abs(wcs));
rhocn=max(abs(rhocs));
kn=1/rhocn;
% kn=1/abs(rhocs(1));
wn=wcn;

kz=0.1*kn; % 25-02-02 01:54

xx=(0.05:0.05:3.95)*wn;
% xx=(1.5:0.05:1.50)*wn;
nx=length(xx);
runtime=cputime;

N=6;
J=8;
if(J==8) % J-pole, usually J=8 is sufficient; other choice: 4, 12
  % 18-12-28 11:11
  bzj(1)=   -0.017340112270401 - 0.046306439626294i;
  bzj(2)=   -0.739917811220052 + 0.839518284620274i;
  bzj(3)=   5.840632105105495 + 0.953602751322040i;
  bzj(4)=   -5.583374181615043 -11.208550459628098i;
  czj(1)=   2.237687725134293 - 1.625941024120362i;
  czj(2)=   1.465234091939142 - 1.789620299603315i;
  czj(3)=   0.839253966367922 - 1.891995211531426i;
  czj(4)=   0.273936218055381 - 1.941787037576095i;

  bzj(5:8)=conj(bzj(1:4));
  czj(5:8)=-conj(czj(1:4));
elseif(J==12) % from Cal_J_pole_bjcj.m
  % J=12; I=12; 18-12-28 22:35
  bzj(1)=  - 10.020983259474214017 - 14.728932929429874883i;
  bzj(2)= - 0.58878169153449514493 + 0.19067303610080007359i;
  bzj(3)= - 0.27475707659732384029 + 3.617920717493884482i;
  bzj(4)= 0.00045713742777499515344 + 0.00027155393843737098852i;
  bzj(5)=  0.017940627032508378515 - 0.036436053276701248142i;
  bzj(6)=  10.366124263145749629 - 2.5069048649816145967i;
  czj(1)= 0.22660012611958088507627 - 2.0716877594897791206264i;
  czj(2)= - 1.70029215163003500750575 - 1.8822474221612724460388i;
  czj(3)= 1.17139325085601178534269 - 1.97725033192085410977458i;
  czj(4)= 3.0666201126826972102007 - 1.59002082593259971758095i;
  czj(5)= 2.307327490410578276422 - 1.7546732543728200653674i;
  czj(6)= 0.687200524906019065672977 - 2.040288525975844018682i;

  bzj(7:12)=conj(bzj(1:6));
  czj(7:12)=-conj(czj(1:6));
end

% z=sqrt(b), 25-02-07 10:00 keep to O(kx^2) & O(1/kx^3)
cn={}; % set L-pole coefficients for Gamma_n, cn(abs(n)+1) for Bessel(n,b) & Bessel(-n,b)
cn{1}.rl=1*[-0.0326560281967822 + 0.0312590495572379i	-0.0326560281967822 - 0.0312590495572379i	-0.000178407293843021 - 0.000966842020120462i	-0.000178407293843021 + 0.000966842020120463i	0.101508158612643 - 0.000790257256424197i	0.101508158612643 + 0.000790257256424225i	0.0407432015112937 + 0.111196889687134i	0.0407432015112937 - 0.111196889687134i	-0.210665457794143 - 0.127867736009404i	-0.210665457794143 + 0.127867736009404i	0.300719673361548 - 0.268390200228919i	0.300719673361548 + 0.268390200228918i];
cn{1}.pl=1*[0.798971222161112 + 0.798971222161112i	0.798971222161112 - 0.798971222161112i	1.09141498636478 + 0.292443764203667i	1.09141498636478 - 0.292443764203667i	-1.09141498636478 + 0.292443764203667i	-1.09141498636478 - 0.292443764203667i	-0.798971222161111 + 0.798971222161112i	-0.798971222161111 - 0.798971222161112i	0.292443764203668 + 1.09141498636478i	0.292443764203668 - 1.09141498636478i	-0.292443764203667 + 1.09141498636478i	-0.292443764203667 - 1.09141498636478i];
cn{2}.rl=2*[0.0526845421472361 + 0.0121444407732702i	0.0526845421472361 - 0.0121444407732702i	0.00968681378150610 - 0.00707933959300272i	0.00968681378150609 + 0.00707933959300272i	-1.72865624075227e-06 + 3.13568771391604e-05i	-1.72865624075227e-06 - 3.13568771391604e-05i	0.104057657163091 - 0.0932387523744934i	0.104057657163091 + 0.0932387523744934i	-0.0174248319482894 - 0.0211374751457164i	-0.0174248319482894 + 0.0211374751457164i	0.0305181488166908 - 0.0212169897060945i	0.0305181488166908 + 0.0212169897060945i	-0.130075076658618 - 0.130041576617214i	-0.130075076658618 + 0.130041576617214i	0.00110639903653167 - 0.00141324934602197i	0.00110639903653167 + 0.00141324934602197i	0.0491836464184503 + 0.229242930408844i	0.0491836464184503 - 0.229242930408844i];
cn{2}.pl=2*[-0.429677128725621 + 0.512069261814323i	-0.429677128725621 - 0.512069261814323i	-0.658303553591159 + 0.116076677994384i	-0.658303553591159 - 0.116076677994384i	0.658303553591159 + 0.116076677994382i	0.658303553591159 - 0.116076677994382i	0.228626424865539 + 0.628145939808705i	0.228626424865539 - 0.628145939808705i	0.429677128725620 + 0.512069261814322i	0.429677128725620 - 0.512069261814322i	-0.578902429502346 + 0.334229473507706i	-0.578902429502346 - 0.334229473507706i	-0.228626424865538 + 0.628145939808704i	-0.228626424865538 - 0.628145939808704i	0.578902429502345 + 0.334229473507707i	0.578902429502345 - 0.334229473507707i	1.94289029309402e-16 + 0.668458947015414i	1.94289029309402e-16 - 0.668458947015414i];
cn{3}.rl=3*[0.00102849410503902 - 0.00398880750413927i	0.00102849410503903 + 0.00398880750413927i	0.0739448110422607 + 0.0230965994089859i	0.0739448110422607 - 0.0230965994089859i	-0.352819347939444 + 0.0654115867476181i	-0.352819347939444 - 0.0654115867476182i	-2.59845615482084e-05 + 3.60606019236606e-05i	-2.59845615482083e-05 - 3.60606019236606e-05i	-0.271439561675746 + 0.0334901111280245i	-0.271439561675746 - 0.0334901111280245i	-0.0137480251335304 - 0.00899571014191486i	-0.0137480251335305 + 0.00899571014191486i	0.165207459958070 + 0.00964464191202503i	0.165207459958070 - 0.00964464191202499i	0.00138676220201072 - 0.000672809321905819i	0.00138676220201072 + 0.000672809321905819i	0.450970325953787 - 0.101427382938049i	0.450970325953787 + 0.101427382938049i	0.0119854461160062 - 0.0262296324358499i	0.0119854461160062 + 0.0262296324358500i];
cn{3}.pl=3*[-0.553026398264425 + 0.0875907765738186i	-0.553026398264425 - 0.0875907765738186i	-0.395923187826969 + 0.395923187826954i	-0.395923187826969 - 0.395923187826954i	0.0875907765738042 + 0.553026398264423i	0.0875907765738042 - 0.553026398264423i	0.553026398264420 + 0.0875907765738121i	0.553026398264420 - 0.0875907765738121i	-0.254198334229531 + 0.498892321240817i	-0.254198334229531 - 0.498892321240817i	0.395923187826957 + 0.395923187826956i	0.395923187826957 - 0.395923187826956i	0.254198334229543 + 0.498892321240809i	0.254198334229543 - 0.498892321240809i	0.498892321240807 + 0.254198334229539i	0.498892321240807 - 0.254198334229539i	-0.0875907765738095 + 0.553026398264410i	-0.0875907765738095 - 0.553026398264410i	-0.498892321240797 + 0.254198334229536i	-0.498892321240797 - 0.254198334229536i];
cn{4}.rl=4*[0.122780505560740 - 0.848449461944997i	0.122780505560740 + 0.848449461944996i	0.00375129816543161 - 0.000360816395396935i	0.00375129816543161 + 0.000360816395396934i	0.171589485331866 + 0.165003781700487i	0.171589485331866 - 0.165003781700487i	-0.00147560768935680 - 0.00129351207406616i	-0.00147560768935680 + 0.00129351207406616i	-0.282114220499818 + 0.377251292054528i	-0.282114220499818 - 0.377251292054528i	-0.316559783034157 - 0.493200530533542i	-0.316559783034157 + 0.493200530533542i	0.144718758174976 - 0.0234431312007449i	0.144718758174976 + 0.0234431312007449i	-0.00803963075534240 - 0.0310496666781358i	-0.00803963075534239 + 0.0310496666781358i	-0.000103890183762794 + 7.49994538010429e-05i	-0.000103890183762794 - 7.49994538010429e-05i	-0.0320559906417901 - 0.0192379963498689i	-0.0320559906417900 + 0.0192379963498689i	0.247376860621391 + 0.872301737515369i	0.247376860621392 - 0.872301737515369i];
cn{4}.pl=4*[-0.142270074584937 + 0.484527377489765i	-0.142270074584937 - 0.484527377489765i	0.459348444762014 + 0.209777405728608i	0.459348444762014 - 0.209777405728608i	0.273014273839729 + 0.424818502350425i	0.273014273839729 - 0.424818502350425i	-0.499842730073363 + 0.0718665349957603i	-0.499842730073363 - 0.0718665349957603i	-0.273014273839730 + 0.424818502350416i	-0.273014273839730 - 0.424818502350416i	0.142270074584907 + 0.484527377489745i	0.142270074584907 - 0.484527377489745i	-0.381640480306392 + 0.330693358643594i	-0.381640480306392 - 0.330693358643594i	-0.459348444761987 + 0.209777405728591i	-0.459348444761987 - 0.209777405728591i	0.499842730073351 + 0.0718665349957164i	0.499842730073351 - 0.0718665349957164i	0.381640480306381 + 0.330693358643598i	0.381640480306381 - 0.330693358643598i	2.70096445209589e-14 + 0.504982726100066i	2.70096445209589e-14 - 0.504982726100066i];
cn{5}.rl=5*[-0.0783818171596823 - 0.00901737421386743i	-0.0783818171596823 + 0.00901737421386739i	0.466055191085621 + 0.961461634182356i	0.466055191085621 - 0.961461634182357i	-0.136403311569855 + 0.472681439671376i	-0.136403311569851 - 0.472681439671381i	2.64014572825837 - 0.0864289137908757i	2.64014572825836 + 0.0864289137908705i	0.00969422288215900 + 0.00914312206435764i	0.00969422288216063 - 0.00914312206435855i	-1.98079333867706 + 1.07657834665877i	-1.98079333867705 - 1.07657834665876i	2.08651229259757e-05 - 1.07896659004580e-05i	2.08651229259765e-05 + 1.07896659004591e-05i	-0.000996298614015476 - 0.000113944209592784i	-0.000996298614015681 + 0.000113944209592885i	-0.0115012423142744 - 0.0978477541223374i	-0.0115012423142684 + 0.0978477541223404i	0.813928405129882 - 1.02767916539219i	0.813928405129904 + 1.02767916539221i	-0.00135571469547755 + 0.00807562141501338i	-0.00135571469547759 - 0.00807562141501337i	0.000106752646449825 + 9.42256382422444e-05i	0.000106752646449824 - 9.42256382422447e-05i	-1.82044498882672 - 0.989062897628273i	-1.82044498882671 + 0.989062897628258i	0.139819774771803 - 0.322716493000516i	0.139819774771801 + 0.322716493000518i];
cn{5}.pl=5*[-0.384679849390900 + 0.241710369507099i	-0.384679849390900 - 0.241710369507099i	-0.241710369506125 + 0.384679849391412i	-0.241710369506125 - 0.384679849391412i	0.241710369505925 + 0.384679849390923i	0.241710369505925 - 0.384679849390923i	-0.0508671865571926 + 0.451458767315290i	-0.0508671865571926 - 0.451458767315290i	0.384679849390888 + 0.241710369505917i	0.384679849390888 - 0.241710369505917i	0.0508671865571799 + 0.451458767315277i	0.0508671865571799 - 0.451458767315277i	0.451458767315241 + 0.0508671865571539i	0.451458767315241 - 0.0508671865571539i	0.428820739594400 + 0.150050866534363i	0.428820739594400 - 0.150050866534363i	0.321249505255621 + 0.321249505255608i	0.321249505255621 - 0.321249505255608i	0.150050866534339 + 0.428820739594349i	0.150050866534339 - 0.428820739594349i	-0.428820739594687 + 0.150050866533368i	-0.428820739594687 - 0.150050866533368i	-0.451458767315045 + 0.0508671865577406i	-0.451458767315045 - 0.0508671865577406i	-0.150050866534258 + 0.428820739594172i	-0.150050866534258 - 0.428820739594172i	-0.321249505255386 + 0.321249505254697i	-0.321249505255386 - 0.321249505254697i];
cn{6}.rl=6*[0.00485770298414914 + 0.00302079581915372i	0.00485770298414915 - 0.00302079581915371i	-0.139267202676968 - 0.244228865455975i	-0.139267202676968 + 0.244228865455975i	-1.39345994193360 - 1.37655975279477i	-1.39345994193359 + 1.37655975279477i	0.893446597825793 - 2.24268957041088i	0.893446597825800 + 2.24268957041088i	-0.414202624937498 + 0.142857913364593i	-0.414202624937503 - 0.142857913364597i	0.00120494554590552 + 0.0162113172511449i	0.00120494554590529 - 0.0162113172511449i	-1.42709169650619 + 0.879145385325977i	-1.42709169650621 - 0.879145385325974i	3.66119166766500e-05 + 1.47683237881559e-06i	3.66119166766502e-05 - 1.47683237881516e-06i	-0.00100562785849773 - 0.000945231331238617i	-0.00100562785849778 + 0.000945231331238643i	0.0648605777962936 - 0.0818091481781729i	0.0648605777962956 + 0.0818091481781736i	1.09022450047827 + 0.256741775107611i	1.09022450047826 - 0.256741775107616i	0.566388056740402 + 2.46713780797402i	0.566388056740408 - 2.46713780797400i	0.825332568873289 + 0.131411157605572i	0.825332568873293 - 0.131411157605578i	5.69616478394458e-05 - 9.68512311201608e-05i	5.69616478394476e-05 + 9.68512311201600e-05i	-0.0381362398624164 + 0.0457485569947034i	-0.0381362398624152 - 0.0457485569947036i];
cn{6}.pl=6*[-0.388310476930244 + 0.126169722216837i	-0.388310476930244 - 0.126169722216837i	-0.303421423085997 + 0.273201876474799i	-0.303421423085997 - 0.273201876474799i	0.0848890538440402 + 0.399371598679916i	0.0848890538440402 - 0.399371598679916i	-0.0848890538440018 + 0.399371598679919i	-0.0848890538440018 - 0.399371598679919i	0.239989072929767 + 0.330316621091007i	0.239989072929767 - 0.330316621091007i	0.353592801073519 + 0.204146898883053i	0.353592801073519 - 0.204146898883053i	-0.166068048692329 + 0.372994944333102i	-0.166068048692329 - 0.372994944333102i	0.406057121621772 + 0.0426783232419557i	0.406057121621772 - 0.0426783232419557i	0.388310476928443 + 0.126169722207912i	0.388310476928443 - 0.126169722207912i	0.303421423084334 + 0.273201876471973i	0.303421423084334 - 0.273201876471973i	0.166068048692042 + 0.372994944332888i	0.166068048692042 - 0.372994944332888i	7.34134975033385e-15 + 0.408293797766089i	7.34134975033385e-15 - 0.408293797766089i	-0.239989072928889 + 0.330316621090003i	-0.239989072928889 - 0.330316621090003i	-0.406057121621069 + 0.0426783232309615i	-0.406057121621069 - 0.0426783232309615i	-0.353592801071394 + 0.204146898877303i	-0.353592801071394 - 0.204146898877303i];
cn{7}.rl=7*[0.0112606221933589 + 0.000235877845872892i	0.0112606221933589 - 0.000235877845872896i	-0.560531813141246 - 0.475619942036212i	-0.560531813141245 + 0.475619942036212i	0.239132320370139 - 0.141362130689284i	0.239132320370136 + 0.141362130689284i	-0.00128520736131186 - 0.00321047497115739i	-0.00128520736131188 + 0.00321047497115741i	-1.66181634252435 + 5.13336316394560i	-1.66181634252435 - 5.13336316394561i	1.94207957648150 + 2.47896091498332i	1.94207957648151 - 2.47896091498333i	10.0610293282456 + 1.42798264402391i	10.0610293282456 - 1.42798264402390i	0.597592800497644 - 6.15717406003889i	0.597592800497629 + 6.15717406003889i	-7.05649321961739 + 5.74038607091072i	-7.05649321961738 - 5.74038607091076i	-4.66776531244099 - 7.20740608596505i	-4.66776531244097 + 7.20740608596505i	7.21516112896044e-05 + 5.60064221278444e-05i	7.21516112896052e-05 - 5.60064221278432e-05i	-1.12908024373274 - 0.195905402601989i	-1.12908024373275 + 0.195905402601977i	-0.0127558574130654 + 0.0402996372065012i	-0.0127558574130653 - 0.0402996372065021i	-7.23867744694928e-05 - 0.000200029237116102i	-7.23867744694929e-05 + 0.000200029237116102i	2.30748197668432 - 0.768167060191986i	2.30748197668432 + 0.768167060191996i	-0.0403525159067318 + 0.127943459665973i	-0.0403525159067327 - 0.127943459665973i];
cn{7}.pl=7*[-0.385100065485338 + 0.116818827725932i	-0.385100065485338 - 0.116818827725932i	-0.311081438513201 + 0.255297938808834i	-0.311081438513201 - 0.255297938808834i	0.311081438512181 + 0.255297938807583i	0.311081438512181 - 0.255297938807583i	0.385100065484404 + 0.116818827720602i	0.385100065484404 - 0.116818827720602i	-0.189703482486607 + 0.354910252991205i	-0.189703482486607 - 0.354910252991205i	0.189703482486194 + 0.354910252991210i	0.189703482486194 - 0.354910252991210i	-0.0394448909190643 + 0.400490698426178i	-0.0394448909190643 - 0.400490698426178i	0.116818827721887 + 0.385100065482945i	0.116818827721887 - 0.385100065482945i	0.0394448909189139 + 0.400490698425874i	0.0394448909189139 - 0.400490698425874i	-0.116818827721559 + 0.385100065482888i	-0.116818827721559 - 0.385100065482888i	0.400490698425454 + 0.0394448909207956i	0.400490698425454 - 0.0394448909207956i	0.255297938806707 + 0.311081438510551i	0.255297938806707 - 0.311081438510551i	0.354910252989324 + 0.189703482486394i	0.354910252989324 - 0.189703482486394i	-0.400490698425089 + 0.0394448909135688i	-0.400490698425089 - 0.0394448909135688i	-0.255297938806037 + 0.311081438510191i	-0.255297938806037 - 0.311081438510191i	-0.354910252988169 + 0.189703482483447i	-0.354910252988169 - 0.189703482483447i];
cn{8}.rl=8*[-5.69344034289440e-06 - 0.00185972949632981i	-5.69344034289568e-06 + 0.00185972949632981i	-0.123376889784460 - 0.194842369140504i	-0.123376889784460 + 0.194842369140504i	0.0576606615639106 + 0.0283449469258770i	0.0576606615639195 - 0.0283449469258777i	-0.478193984327371 - 0.0106009047350560i	-0.478193984327369 + 0.0106009047350565i	1.08904695897849 + 0.140860723318460i	1.08904695897846 - 0.140860723318479i	-0.441969149960354 + 1.22931831014985i	-0.441969149960362 - 1.22931831014986i	-6.40060348843150e-06 - 0.000877467453980588i	-6.40060348846515e-06 + 0.000877467453980564i	1.99986657203867e-05 + 1.18986951353607e-05i	1.99986657203925e-05 - 1.18986951353575e-05i	-0.432842084029981 + 0.459601339816289i	-0.432842084029936 - 0.459601339816322i	0.810612933937178 - 0.391110408242074i	0.810612933937181 + 0.391110408242080i	-0.00881052691454265 + 0.00540510593195716i	-0.00881052691454473 - 0.00540510593195553i	-0.0468562493726993 - 0.244998782676863i	-0.0468562493727132 + 0.244998782676887i	-0.696692069469338 - 1.19918684149241i	-0.696692069469347 + 1.19918684149241i	-0.0447419557337206 + 0.0830419356958610i	-0.0447419557337205 - 0.0830419356958613i	0.0194934779435083 + 0.00395595248341660i	0.0194934779435084 - 0.00395595248341656i	-4.37051510818228e-05 + 1.00919753567271e-05i	-4.37051510818228e-05 - 1.00919753567270e-05i	0.321638570223690 + 0.0895911209130209i	0.321638570223687 - 0.0895911209130214i];
cn{8}.pl=8*[-0.329451238721352 + 0.0937369591968075i	-0.329451238721352 - 0.0937369591968075i	-0.230758938374810 + 0.253130497124110i	-0.230758938374810 - 0.253130497124110i	0.273342435724289 + 0.206418625724516i	0.273342435724289 - 0.206418625724516i	-0.123735019176827 + 0.319396902369031i	-0.123735019176827 - 0.319396902369031i	0.123735019176841 + 0.319396902368725i	0.123735019176841 - 0.319396902368725i	-4.04752620308813e-13 + 0.342526986109744i	-4.04752620308813e-13 - 0.342526986109744i	0.329451238718830 + 0.0937369591984378i	0.329451238718830 - 0.0937369591984378i	0.341065826372236 + 0.0316044030806536i	0.341065826372236 - 0.0316044030806536i	0.180317222140609 + 0.291222313040317i	0.180317222140609 - 0.291222313040317i	-0.0629391685361730 + 0.336694813260726i	-0.0629391685361730 - 0.336694813260726i	0.306617584262620 + 0.152677415597657i	0.306617584262620 - 0.152677415597657i	0.230758938373129 + 0.253130497122484i	0.230758938373129 - 0.253130497122484i	0.0629391685366243 + 0.336694813260427i	0.0629391685366243 - 0.336694813260427i	-0.273342435722627 + 0.206418625723772i	-0.273342435722627 - 0.206418625723772i	-0.306617584262102 + 0.152677415598057i	-0.306617584262102 - 0.152677415598057i	-0.341065826370754 + 0.0316044030838056i	-0.341065826370754 - 0.0316044030838056i	-0.180317222140132 + 0.291222313038911i	-0.180317222140132 - 0.291222313038911i];

L=zeros(length(cn),1);
for n=1:length(cn)
  L(n)=length(cn{n}.rl);
end

kxx=zeros(nx,5);
for jx=1:nx
  jx
  w=xx(jx);

  nL=sum(L(1:(N+1)));
  NSL=S*nL;
  NSL3=3*NSL;
  NN=NSL3+4;
  matM=zeros(NN,NN);

  % kx*X=M*X, with X=[vxsl,vys,vzsl,Ey,Ez,By,Bz], Jx=sum(vxsl),
  % Jy=sum(vysl), Jz=sum(vzsl)
  snl=0;
  for s=1:S
    xsj=zeros(J,1);
    for j=1:J
      xsj(j)=(w-kz*vts(s)*czj(j))/wcs(s);
    end

    for n=0:N
      for l=1:L(abs(n)+1)
        snl=snl+1;
        pln=cn{abs(n)+1}.pl(l);
        rln=cn{abs(n)+1}.rl(l);
        csnl=pln/abs(rhocs(s));

        ctmpxx=0; ctmpxy=0; ctmpxz=0;
        ctmpyy=0; ctmpyz=0; ctmpzz=0;
        for j=1:J
          ctmpxx=ctmpxx+bzj(j)/pln^2*(n^2*xsj(j)/(xsj(j)^2-n^2));
          ctmpxy=ctmpxy+bzj(j)*( ...
            0.5*(n+1)^2/(xsj(j)^2-(n+1)^2)- ...
            (n>=1)*n^2/(xsj(j)^2-n^2)+ ...
            (n>=2)*0.5*(n-1)^2/(xsj(j)^2-(n-1)^2));
          ctmpxz=ctmpxz+sgns(s)/pln*bzj(j)*czj(j)*(n^2/(xsj(j)^2-n^2));
          ctmpyy=ctmpyy+bzj(j)*(xsj(j)/pln^2*n^2/(xsj(j)^2-n^2)+ ...
            pln^2/xsj(j)*( -(n+1)^2/(xsj(j)^2-(n+1)^2)+ ...
            (n>=1)*2*n^2/(xsj(j)^2-n^2)- ...
            (n>=2)*(n-1)^2/(xsj(j)^2-(n-1)^2)));
          ctmpyz=ctmpyz+sgns(s)*pln*bzj(j)*czj(j)/xsj(j)*( ...
            0.5*(n+1)^2/(xsj(j)^2-(n+1)^2)- ...
            (n>=1)*n^2/(xsj(j)^2-n^2)+ ...
            (n>=2)*0.5*(n-1)^2/(xsj(j)^2-(n-1)^2));
          ctmpzz=ctmpzz+bzj(j)*czj(j)^2*xsj(j)*( ...
            1+(n>=1))/(xsj(j)^2-n^2);
        end

        btmp=epsilon0*wps2(s)/wcs(s)*rln/absrhocs(s);
        blxx=-2i*btmp*ctmpxx;
        blxy=2*btmp*ctmpxy;
        blyx=-blxy;
        blxz=-2i*sqrt(2)*btmp*ctmpxz;
        blzx=blxz;
        blyy=-2i*btmp*ctmpyy;
        blyz=-2*sqrt(2)*btmp*ctmpyz; % 25-02-08 23:45 fix bug
        blzy=-blyz;
        blzz=-2i*btmp*ctmpzz;

        % v_snl,v_snl
        matM(snl,snl)=matM(snl,snl)+csnl; % x
        matM(NSL+snl,NSL+snl)=matM(NSL+snl,NSL+snl)+csnl; % y
        matM(2*NSL+snl,2*NSL+snl)=matM(2*NSL+snl,2*NSL+snl)+csnl; % z

        matM(0*NSL+snl,NSL3+1)=blxy; % vx_snl,Ey
        matM(0*NSL+snl,NSL3+2)=blxz; % vx_snl,Ez
        matM(0*NSL+snl,NSL3+3)=kz*c2/w*blxx; % vx_snl,By
        matM(1*NSL+snl,NSL3+1)=blyy; % vy_snl,Ey
        matM(1*NSL+snl,NSL3+2)=blyz; % vy_snl,Ez
        matM(1*NSL+snl,NSL3+3)=kz*c2/w*blyx; % vy_snl,By
        matM(2*NSL+snl,NSL3+1)=blzy; % vz_snl,Ey
        matM(2*NSL+snl,NSL3+2)=blzz; % vz_snl,Ez
        matM(2*NSL+snl,NSL3+3)=kz*c2/w*blzx; % vz_snl,By

        for lp=1:NSL % vxyz_snl, vx_snl'
          matM(0*NSL+snl,lp)=matM(0*NSL+snl,lp)-1i/(w*epsilon0)*blxx;
          matM(1*NSL+snl,lp)=matM(1*NSL+snl,lp)-1i/(w*epsilon0)*blyx;
          matM(2*NSL+snl,lp)=matM(2*NSL+snl,lp)-1i/(w*epsilon0)*blzx;
        end

        matM(NSL3+2,0*NSL+snl)=-1i*kz/(w*epsilon0); % (Ez,Jx), Jx=sum{vx_snl}
        matM(NSL3+3,2*NSL+snl)=-1i/(c2*epsilon0); % (By,Jz), Jz=sum{vz_snl}
        matM(NSL3+4,1*NSL+snl)=1i/(c2*epsilon0); % (Bz,Jy), Jy=sum{vy_snl}
      end
    end
  end

  % Ey,Ez,By,Bz
  matM(NSL3+1,NSL3+4)=w; % (Ey,Bz)
  matM(NSL3+2,NSL3+3)=kz^2*c2/w-w; % (Ez,By)
  matM(NSL3+3,NSL3+2)=-w/c2; % (By,Ez)
  matM(NSL3+4,NSL3+1)=w/c2-kz^2/w; % (Bz,Ey)

  d=eig(matM);
  % matMv=vpa(matM,20); d=eig(matMv); % 25-02-08 15:00 vpa slow & not must

  kx=d(real(d)>1e-5*kn);
  [tmp,ind]=sort(abs(imag(kx))); % keep Re(kx)>0 and min(abs(Im(kx))) solutions
  kx=kx(ind);
  if(~isnan(kx))
    kxx(jx,1:5)=kx(1:5);
  end
end

runtime=cputime-runtime;
%%
close all;
h=figure('unit','normalized','Position',[0.01 0.05 0.5 0.5],...
  'DefaultAxesLineWidth',2,...
  'DefaultAxesFontSize',14);
jplt=2;
if(jplt==1)
  subplot(121);
  plot(real(kxx(:,1))/kn,xx/wn,'x','LineWidth',2); hold on;
  plot(real(kxx(:,2))/kn,xx/wn,'x','LineWidth',2); hold on;
  plot(real(kxx(:,3))/kn,xx/wn,'x','LineWidth',2); hold on;
  plot(real(kxx(:,4))/kn,xx/wn,'x','LineWidth',2); hold on;
  xlim([0,5]);ylim([0,5]);
  xlabel('Re(k_\perp)');ylabel('\omega_r');
  subplot(122);
  plot(abs(imag(kxx(:,1)))/kn,xx/wn,'x','LineWidth',2); hold on;
  plot(abs(imag(kxx(:,2)))/kn,xx/wn,'x','LineWidth',2); hold on;
  plot(abs(imag(kxx(:,3)))/kn,xx/wn,'x','LineWidth',2); hold on;
  plot(abs(imag(kxx(:,4)))/kn,xx/wn,'x','LineWidth',2); hold on;
  % xlim([0,5]);
  ylim([0,5]);
  xlabel('Im(k_\perp)');ylabel('\omega_r');
else
  subplot(121);
  semilogy(xx/wn,real(kxx(:,1)),'x','LineWidth',2); hold on;
  semilogy(xx/wn,real(kxx(:,2)),'x','LineWidth',2); hold on;
  % semilogy(xx/wn,real(kxx(:,3)),'x','LineWidth',2); hold on;
  % semilogy(xx/wn,real(kxx(:,4)),'x','LineWidth',2); hold on;
  xlim([0,5]);
  % ylim([1e0,1e4]);
  ylabel('Re(k_\perp)');xlabel('\omega_r');
  subplot(122);
  semilogy(xx/wn,abs(imag(kxx(:,1))),'x','LineWidth',2); hold on;
  semilogy(xx/wn,abs(imag(kxx(:,2))),'x','LineWidth',2); hold on;
  % semilogy(xx/wn,abs(imag(kxx(:,3))),'x','LineWidth',2); hold on;
  % semilogy(xx/wn,abs(imag(kxx(:,4))),'x','LineWidth',2); hold on;
  xlim([0,5]);
  % ylim([1e0,1e4]);
  ylabel('Im(k_\perp)');xlabel('\omega_r');
end
title(['k_z=',num2str(kz),', N=',num2str(N)]);

print(gcf,'-dpng',['em3d_Lpole_S=',num2str(S),',B0=',num2str(B0,3),...
  ',n00=',num2str(n00,3),',T00=',num2str(T00,3),',ns=',num2str(ns_unit,3),...
  ',ms=',num2str(ms/me,4),',qs=',num2str(qs/qe,3),...
  ',Ts=',num2str(Ts_unit,3),',k_z=',num2str(kz,3),',N=',num2str(N),'.png']);

if(jcase==1)
  save(['ICW_Lpole_kz=',num2str(kz),'_N=',num2str(N),'.mat'],'kxx','xx','kn','wn','kz','N');
  % save('BW_Lpole.mat','kxx','xx','kn','wn','kz','N');
else
  save(['ECW_Lpole_kz=',num2str(kz),'_N=',num2str(N),'.mat'],'kxx','xx','kn','wn','kz','N');
end

%%
if(1==0)
  figure;
  plot(real(d),imag(d),'rx');
  if(jcase==1)
    save(['ICW_Lpole_d_kz=',num2str(kz),'_N=',num2str(N),'.mat'],'d','kxx','xx','kn','wn','kz','N');
  else
    save(['ECW_Lpole_d_kz=',num2str(kz),'_N=',num2str(N),'.mat'],'d','kxx','xx','kn','wn','kz','N');
  end
end
